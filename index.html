<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ساخت آنلاین پاورپوینت</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700&family=Lalezar&family=Yekan&display=swap" rel="stylesheet">
    <style>
        /* استایل‌های قبلی حفظ می‌شوند */
        /* استایل‌های جدید برای قابلیت‌های اضافه شده */
        .template-gallery {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 80vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .template-item {
            width: 200px;
            aspect-ratio: 16/9;
            margin: 10px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .template-item:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .toolbar-group.formatting {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .format-button {
            padding: 5px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .slide-transition-select {
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
        }

        .slide-notes {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: rgba(255,255,255,0.9);
            border-top: 1px solid var(--border);
            padding: 10px;
            font-size: 14px;
            display: none;
        }

        .show-notes .slide-notes {
            display: block;
        }

        .slide-content {
            height: calc(100% - 100px);
        }

        .shape-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .shape-button {
            width: 30px;
            height: 30px;
            padding: 0;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- نوار ابزار اصلی با قابلیت‌های جدید -->
    <div class="main-toolbar">
        <div class="toolbar-group">
            <button class="btn btn-primary" onclick="addNewSlide()">
                <span class="icon">+</span>
                اسلاید جدید
            </button>
            <button class="btn" onclick="showTemplates()">
                <span class="icon">📋</span>
                قالب‌ها
            </button>
            <button class="btn btn-danger" onclick="deleteCurrentSlide()">
                <span class="icon">×</span>
                حذف اسلاید
            </button>
        </div>
        
        <div class="toolbar-group formatting">
            <input type="text" class="style-select font-size" placeholder="اندازه فونت" oninput="applyStyleToSelection('fontSize', this.value + 'px')" title="اندازه فونت">
            <select class="style-select font-family" onchange="applyStyleToSelection('fontFamily', this.value)">
                <option value="Vazirmatn">وزیر</option>
                <option value="Lalezar">لاله‌زار</option>
                <option value="Yekan">یکان</option>
            </select>
            <div class="color-group">
                <input type="color" id="textColor" onchange="applyStyleToSelection('color', this.value)" title="رنگ متن">
                <label for="textColor" class="color-label">رنگ متن</label>
            </div>
            <button class="format-button" onclick="applyStyleToSelection('textAlign', 'right')">⇚</button>
            <button class="format-button" onclick="applyStyleToSelection('textAlign', 'center')">☰</button>
            <button class="format-button" onclick="applyStyleToSelection('textAlign', 'left')">⇛</button>
            <button class="format-button" onclick="toggleStyle('bold')">B</button>
            <button class="format-button" onclick="toggleStyle('italic')">I</button>
            <button class="format-button" onclick="toggleBulletList()">•</button>
            <button class="format-button" onclick="toggleNumberedList()">1.</button>
        </div>

        <div class="toolbar-group">
            <div class="color-group">
                <input type="color" id="bgColor" onchange="updateSlideBackground(this.value)" title="رنگ پس‌زمینه">
                <label for="bgColor" class="color-label">پس‌زمینه</label>
            </div>
            <select class="slide-transition-select" onchange="updateSlideTransition(this.value)">
                <option value="none">بدون جلوه</option>
                <option value="fade">محو شدن</option>
                <option value="slide">اسلاید</option>
                <option value="zoom">بزرگنمایی</option>
            </select>
        </div>

        <div class="toolbar-group">
            <button class="btn" onclick="toggleNotes()">
                <span class="icon">📝</span>
                یادداشت‌ها
            </button>
            <button class="btn btn-success" onclick="generatePPT()">
                <span class="icon">⬇️</span>
                دانلود
            </button>
            <button class="btn" onclick="startPresentation()">
                <span class="icon">▶️</span>
                نمایش
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="slide-list" id="slideList">
            <!-- پیش‌نمایش اسلایدها -->
        </div>
        
        <div class="slide-workspace">
            <div class="slide-canvas" id="currentSlide">
                <!-- محتوای اسلاید فعلی -->
                <div class="shape-toolbar">
                    <button class="shape-button" onclick="addShape('rectangle')">▢</button>
                    <button class="shape-button" onclick="addShape('circle')">○</button>
                    <button class="shape-button" onclick="addShape('arrow')">→</button>
                </div>
                <div class="slide-notes" contenteditable="true" spellcheck="false">
                    یادداشت‌های اسلاید...
                </div>
            </div>
        </div>
    </div>

    <!-- گالری قالب‌ها -->
    <div class="template-gallery" id="templateGallery">
        <h3>قالب‌های آماده</h3>
        <div class="template-list">
            <!-- قالب‌ها به صورت پویا اضافه می‌شوند -->
        </div>
    </div>

    <script>
        let slides = [];
        let currentSlideIndex = 0;
        let templates = [
            { name: 'ساده', background: '#ffffff' },
            { name: 'تیره', background: '#333333' },
            { name: 'گرادیان', background: 'linear-gradient(45deg, #ff6b6b, #4ecdc4)' },
            // قالب‌های بیشتر...
        ];

        function createSlideContent() {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'slide-content';
            contentDiv.contentEditable = true;
            contentDiv.dir = 'rtl';
            contentDiv.spellcheck = false;

            contentDiv.addEventListener('mouseup', handleTextSelection);
            contentDiv.addEventListener('keyup', handleTextSelection);
            contentDiv.addEventListener('input', () => {
                saveState();
                updateSlidePreview(currentSlideIndex);
            });
            
            return contentDiv;
        }

        function handleTextSelection() {
            const selection = window.getSelection();
            if (selection && selection.toString()) {
                updateToolbarWithSelection(selection);
            }
        }

        function updateToolbarWithSelection(selection) {
            try {
                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                const computedStyle = window.getComputedStyle(
                    container.nodeType === 3 ? container.parentNode : container
                );

                document.querySelector('.font-family').value = 
                    computedStyle.fontFamily.split(',')[0].replace(/['\"]+/g, '') || 'Vazirmatn';
                document.querySelector('.font-size').value = 
                    parseInt(computedStyle.fontSize) || '24';
                document.querySelector('#textColor').value = 
                    rgbToHex(computedStyle.color);

                document.querySelector('[onclick="toggleStyle(\'bold\')"]')
                    .classList.toggle('active', computedStyle.fontWeight >= 700);
                document.querySelector('[onclick="toggleStyle(\'italic\')"]')
                    .classList.toggle('active', computedStyle.fontStyle === 'italic');
            } catch (error) {
                console.log('Selection update error:', error);
            }
        }

        function applyStyleToSelection(property, value) {
            const selection = window.getSelection();
            if (!selection.toString()) return;

            try {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                
                span.style[property] = value;
                
                if (range.commonAncestorContainer.parentNode !== document.querySelector('.slide-content')) {
                    const parentStyles = window.getComputedStyle(range.commonAncestorContainer.parentNode);
                    const stylesToKeep = ['fontSize', 'fontFamily', 'color', 'fontWeight', 'fontStyle', 'textAlign'];
                    
                    stylesToKeep.forEach(style => {
                        if (style !== property && parentStyles[style]) {
                            span.style[style] = parentStyles[style];
                        }
                    });
                }

                if (range.commonAncestorContainer.nodeType === 3) {
                    range.surroundContents(span);
                } else {
                    const text = range.extractContents();
                    span.appendChild(text);
                    range.insertNode(span);
                }
                
                cleanupRedundantSpans(document.querySelector('.slide-content'));
                
                saveState();
                updateSlidePreview(currentSlideIndex);
            } catch (error) {
                console.log('Style application error:', error);
            }
        }

        function toggleStyle(style) {
            const selection = window.getSelection();
            if (!selection.toString()) return;

            try {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                
                if (style === 'bold') {
                    const isBold = window.getComputedStyle(range.commonAncestorContainer.parentNode).fontWeight >= 700;
                    span.style.fontWeight = isBold ? 'normal' : 'bold';
                } else if (style === 'italic') {
                    const isItalic = window.getComputedStyle(range.commonAncestorContainer.parentNode).fontStyle === 'italic';
                    span.style.fontStyle = isItalic ? 'normal' : 'italic';
                }

                if (range.commonAncestorContainer.nodeType === 3) {
                    range.surroundContents(span);
                } else {
                    const text = range.extractContents();
                    span.appendChild(text);
                    range.insertNode(span);
                }

                const button = document.querySelector(`[onclick="toggleStyle('${style}')"]`);
                button.classList.toggle('active');
                
                saveState();
                updateSlidePreview(currentSlideIndex);
            } catch (error) {
                console.log('Style toggle error:', error);
            }
        }

        function toggleBulletList() {
            const selection = window.getSelection();
            if (!selection.toString()) return;

            const list = document.createElement('ul');
            list.style.listStyleType = 'disc';
            
            const selectedText = selection.toString();
            const lines = selectedText.split('\n');
            
            lines.forEach(line => {
                if (line.trim()) {
                    const li = document.createElement('li');
                    li.textContent = line;
                    list.appendChild(li);
                }
            });

            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(list);
            
            saveState();
            updateSlidePreview(currentSlideIndex);
        }

        function toggleNumberedList() {
            const selection = window.getSelection();
            if (!selection.toString()) return;

            const list = document.createElement('ol');
            
            const selectedText = selection.toString();
            const lines = selectedText.split('\n');
            
            lines.forEach(line => {
                if (line.trim()) {
                    const li = document.createElement('li');
                    li.textContent = line;
                    list.appendChild(li);
                }
            });

            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(list);
            
            saveState();
            updateSlidePreview(currentSlideIndex);
        }

        function addShape(type) {
            const shape = document.createElement('div');
            shape.className = 'slide-shape';
            
            switch(type) {
                case 'rectangle':
                    shape.style.width = '100px';
                    shape.style.height = '60px';
                    shape.style.border = '2px solid black';
                    break;
                case 'circle':
                    shape.style.width = '80px';
                    shape.style.height = '80px';
                    shape.style.borderRadius = '50%';
                    shape.style.border = '2px solid black';
                    break;
                case 'arrow':
                    shape.innerHTML = '→';
                    shape.style.fontSize = '40px';
                    break;
            }
            
            shape.style.position = 'absolute';
            shape.style.left = '50%';
            shape.style.top = '50%';
            shape.style.transform = 'translate(-50%, -50%)';
            shape.style.cursor = 'move';
            
            makeElementDraggable(shape);
            document.querySelector('.slide-content').appendChild(shape);
            
            saveState();
            updateSlidePreview(currentSlideIndex);
        }

        function makeElementDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function showTemplates() {
            const gallery = document.getElementById('templateGallery');
            const templateList = gallery.querySelector('.template-list');
            templateList.innerHTML = '';
            
            templates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.style.background = template.background;
                item.onclick = () => applyTemplate(template);
                templateList.appendChild(item);
            });
            
            gallery.style.display = 'block';
        }

        function applyTemplate(template) {
            updateSlideBackground(template.background);
            document.getElementById('templateGallery').style.display = 'none';
        }

        function toggleNotes() {
            document.querySelector('.slide-canvas').classList.toggle('show-notes');
        }

        function updateSlideTransition(transition) {
            slides[currentSlideIndex].transition = transition;
            saveState();
        }

        async function generatePPT() {
            try {
                const pptx = new PptxGenJS();
                
                for (const slide of slides) {
                    const pptSlide = pptx.addSlide();
                    pptSlide.background = { color: slide.background };

                    if (slide.content.trim()) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = slide.content;
                        
                        // پردازش المان‌های متنی با استایل‌های مختلف
                        const textElements = [];
                        processTextElements(tempDiv, textElements);

                        // اضافه کردن هر بخش متن با استایل‌های مخصوص به خود
                        textElements.forEach((element, index) => {
                            const styles = window.getComputedStyle(element.node);
                            pptSlide.addText(element.text, {
                                x: '5%',
                                y: `${5 + (index * 10)}%`,
                                w: '90%',
                                h: '10%',
                                fontSize: parseInt(styles.fontSize) || 24,
                                fontFace: styles.fontFamily.split(',')[0].replace(/['"]+/g, '') || 'Vazirmatn',
                                color: rgbToHex(styles.color).replace('#', ''),
                                bold: styles.fontWeight >= 700,
                                italic: styles.fontStyle === 'italic',
                                align: styles.textAlign === 'right' ? 'right' : 
                                       styles.textAlign === 'center' ? 'center' : 'left',
                                rtlMode: true
                            });
                        });

                        // اضافه کردن یادداشت‌ها
                        if (slide.notes) {
                            pptSlide.addNotes(slide.notes);
                        }
                    }

                    // اعمال جلوه‌های انتقال
                    if (slide.transition && slide.transition !== 'none') {
                        pptSlide.transition = { name: slide.transition };
                    }
                }

                await pptx.writeFile({ fileName: `presentation-${Date.now()}.pptx` });
                alert('پاورپوینت با موفقیت ساخته شد!');

            } catch (error) {
                alert(`خطا در ساخت پاورپوینت: ${error.message}`);
                console.error(error);
            }
        }

        function startPresentation() {
            // ایجاد حالت نمایش تمام صفحه
            const presentationContainer = document.createElement('div');
            presentationContainer.style.position = 'fixed';
            presentationContainer.style.top = '0';
            presentationContainer.style.left = '0';
            presentationContainer.style.width = '100vw';
            presentationContainer.style.height = '100vh';
            presentationContainer.style.background = 'black';
            presentationContainer.style.zIndex = '9999';
            
            const slideDisplay = document.createElement('div');
            slideDisplay.style.position = 'absolute';
            slideDisplay.style.top = '50%';
            slideDisplay.style.left = '50%';
            slideDisplay.style.transform = 'translate(-50%, -50%)';
            slideDisplay.style.width = '80%';
            slideDisplay.style.height = '80%';
            slideDisplay.style.background = 'white';
            
            presentationContainer.appendChild(slideDisplay);
            document.body.appendChild(presentationContainer);
            
            let currentSlideInPresentation = 0;
            
            function showSlide(index) {
                slideDisplay.innerHTML = '';
                const slide = slides[index];
                slideDisplay.style.background = slide.background;
                const content = document.createElement('div');
                content.innerHTML = slide.content;
                content.style.padding = '2rem';
                slideDisplay.appendChild(content);
            }
            
            showSlide(currentSlideInPresentation);
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    if (e.key === 'ArrowRight' && currentSlideInPresentation < slides.length - 1) {
                        currentSlideInPresentation++;
                    } else if (e.key === 'ArrowLeft' && currentSlideInPresentation > 0) {
                        currentSlideInPresentation--;
                    }
                    showSlide(currentSlideInPresentation);
                } else if (e.key === 'Escape') {
                    document.body.removeChild(presentationContainer);
                }
            });
        }

        function processTextElements(container, result) {
            Array.from(container.childNodes).forEach(node => {
                if (node.nodeType === 3) { // متن ساده
                    if (node.textContent.trim()) {
                        result.push({
                            text: node.textContent,
                            node: node.parentElement || container
                        });
                    }
                } else if (node.nodeType === 1) { // المان HTML
                    if (node.childNodes.length > 0) {
                        processTextElements(node, result);
                    } else if (node.textContent.trim()) {
                        result.push({
                            text: node.textContent,
                            node: node
                        });
                    }
                }
            });
        }

        function cleanupRedundantSpans(container) {
            const spans = container.getElementsByTagName('span');
            for (let i = spans.length - 1; i >= 0; i--) {
                const span = spans[i];
                if (span.parentNode && span.parentNode.nodeName === 'SPAN') {
                    const parentSpan = span.parentNode;
                    if (hasIdenticalStyles(span, parentSpan)) {
                        while (span.firstChild) {
                            parentSpan.insertBefore(span.firstChild, span);
                        }
                        parentSpan.removeChild(span);
                    }
                }
            }
        }

        function hasIdenticalStyles(elem1, elem2) {
            const style1 = window.getComputedStyle(elem1);
            const style2 = window.getComputedStyle(elem2);
            const stylesToCompare = ['fontSize', 'fontFamily', 'color', 'fontWeight', 'fontStyle', 'textAlign'];
            
            return stylesToCompare.every(style => style1[style] === style2[style]);
        }

        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const values = rgb.match(/\d+/g);
            return values ? `#${values.map(x => parseInt(x).toString(16).padStart(2, '0')).join('')}` : '#000000';
        }

        function saveState() {
            const currentContent = document.querySelector('.slide-content');
            if (currentContent) {
                slides[currentSlideIndex].content = currentContent.innerHTML;
            }
            
            const notes = document.querySelector('.slide-notes');
            if (notes) {
                slides[currentSlideIndex].notes = notes.innerHTML;
            }
            
            localStorage.setItem('slides', JSON.stringify(slides));
            localStorage.setItem('currentSlideIndex', currentSlideIndex);
        }

        function loadState() {
            const savedSlides = localStorage.getItem('slides');
            const savedIndex = localStorage.getItem('currentSlideIndex');
            
            if (savedSlides) {
                slides = JSON.parse(savedSlides);
                currentSlideIndex = parseInt(savedIndex) || 0;
                updateSlidesList();
                renderCurrentSlide();
            } else {
                addNewSlide();
            }
        }

        // اضافه کردن توابع اصلی قبلی (addNewSlide، deleteCurrentSlide، و غیره)
        // [کد توابع قبلی را حفظ کنید]

        window.addEventListener('load', loadState);
    </script>
</body>
</html>
