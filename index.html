<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پاورپوینت آنلاین</title>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: IRANSans;
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/iran-sans@latest/dist/iran-sans-regular.woff2') format('woff2');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: IRANSans, sans-serif;
        }

        body {
            overflow: hidden;
            background: #f0f0f0;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: #2b579a;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 10px 20px;
            z-index: 1000;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            margin-left: 20px;
            padding: 0 10px;
            border-left: 1px solid rgba(255,255,255,0.2);
        }

        .editor-container {
            position: fixed;
            top: 100px;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .slides-panel {
            width: 200px;
            background: #fff;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .main-slide {
            flex: 1;
            background: #e6e6e6;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        .active-slide {
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 960px;
            height: 540px;
            position: relative;
        }

        .tool-button {
            padding: 8px 15px;
            margin: 0 5px;
            background: transparent;
            border: 1px solid white;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
        }

        .tool-button i {
            margin-left: 5px;
        }

        .tool-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .slide-thumbnail {
            position: relative;
            width: 180px;
            height: 101px;
            margin: 10px 0;
            background: white;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-thumbnail:hover {
            border-color: #2b579a;
        }

        .slide-thumbnail.active {
            border: 2px solid #2b579a;
        }

        .slide-element {
            position: absolute;
            min-width: 50px;
            min-height: 20px;
            cursor: move;
        }

        .slide-element:hover .element-controls {
            display: flex;
        }

        .element-controls {
            display: none;
            position: absolute;
            top: -30px;
            right: 0;
            background: #2b579a;
            border-radius: 4px;
            padding: 2px;
        }

        .element-control-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
        }

        .element-control-btn:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .context-menu-item i {
            margin-left: 8px;
            width: 20px;
        }

        .context-menu-item:hover {
            background: #f0f0f0;
        }

        .text-formatting {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .formatting-button {
            padding: 5px;
            margin: 0 2px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 2px;
        }

        .formatting-button:hover {
            background: #f0f0f0;
        }

        .color-picker {
            margin: 0 5px;
        }

        @media screen and (max-width: 768px) and (orientation: portrait) {
            body:before {
                content: "لطفاً گوشی خود را به حالت افقی بچرخانید";
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #2b579a;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                padding: 20px;
                text-align: center;
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-row">
            <div class="toolbar-group">
                <button class="tool-button" id="newSlide"><i class="fas fa-plus"></i> اسلاید جدید</button>
                <button class="tool-button" id="deleteSlide"><i class="fas fa-trash"></i> حذف اسلاید</button>
            </div>
            <div class="toolbar-group">
                <button class="tool-button" id="addText"><i class="fas fa-font"></i> متن</button>
                <button class="tool-button" id="addImage"><i class="fas fa-image"></i> تصویر</button>
                <button class="tool-button" id="addShape"><i class="fas fa-shapes"></i> شکل</button>
            </div>
            <div class="toolbar-group">
                <button class="tool-button" id="addAnimation"><i class="fas fa-film"></i> انیمیشن</button>
                <button class="tool-button" id="addTransition"><i class="fas fa-magic"></i> جلوه انتقال</button>
            </div>
            <div class="toolbar-group">
                <button class="tool-button" id="savePresentation"><i class="fas fa-save"></i> ذخیره</button>
                <button class="tool-button" id="downloadPPT"><i class="fas fa-download"></i> دانلود</button>
            </div>
        </div>
        <div class="toolbar-row" id="textFormatting" style="display: none;">
            <!-- ابزارهای قالب‌بندی متن -->
            <select class="formatting-button" id="fontFamily">
                <option value="IRANSans">ایران سنس</option>
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
            </select>
            <select class="formatting-button" id="fontSize">
                <option value="12">12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="24">24</option>
                <option value="36">36</option>
            </select>
            <button class="formatting-button" id="bold"><i class="fas fa-bold"></i></button>
            <button class="formatting-button" id="italic"><i class="fas fa-italic"></i></button>
            <button class="formatting-button" id="underline"><i class="fas fa-underline"></i></button>
            <input type="color" class="color-picker" id="textColor" value="#000000">
            <button class="formatting-button" id="alignRight"><i class="fas fa-align-right"></i></button>
            <button class="formatting-button" id="alignCenter"><i class="fas fa-align-center"></i></button>
            <button class="formatting-button" id="alignLeft"><i class="fas fa-align-left"></i></button>
        </div>
    </div>

    <div class="editor-container">
        <div class="slides-panel" id="slidesPanel">
            <!-- پنل اسلایدها -->
        </div>
        <div class="main-slide">
            <div class="active-slide" id="currentSlide">
                <!-- محتوای اسلاید فعال -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        class Presentation {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = 0;
                this.nextZIndex = 1;
                this.selectedElement = null;
                this.init();
            }

            init() {
                const savedData = this.loadFromCookie();
                if (savedData) {
                    this.slides = savedData.slides;
                    this.currentSlideIndex = savedData.currentSlideIndex;
                    this.nextZIndex = savedData.nextZIndex || 1;
                } else {
                    this.addNewSlide();
                }
                this.setupEventListeners();
                this.render();
            }

            addNewSlide() {
                this.slides.push({
                    id: Date.now(),
                    elements: [],
                    background: '#ffffff',
                    transition: 'none'
                });
                this.currentSlideIndex = this.slides.length - 1;
                this.saveToCookie();
            }

            deleteSlide() {
                if (this.slides.length > 1) {
                    this.slides.splice(this.currentSlideIndex, 1);
                    if (this.currentSlideIndex >= this.slides.length) {
                        this.currentSlideIndex = this.slides.length - 1;
                    }
                    this.saveToCookie();
                    this.render();
                } else {
                    alert('حداقل یک اسلاید باید وجود داشته باشد');
                }
            }

            saveToCookie() {
                const data = {
                    slides: this.slides,
                    currentSlideIndex: this.currentSlideIndex,
                    nextZIndex: this.nextZIndex
                };
                const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();
                document.cookie = `presentation=${JSON.stringify(data)}; expires=${expires}; path=/`;
            }

            loadFromCookie() {
                const cookie = document.cookie.split(';').find(c => c.trim().startsWith('presentation='));
                if (cookie) {
                    return JSON.parse(cookie.split('=')[1]);
                }
                return null;
            }

            setupEventListeners() {
                document.getElementById('newSlide').addEventListener('click', () => this.addNewSlide());
                document.getElementById('deleteSlide').addEventListener('click', () => this.deleteSlide());
                
                document.getElementById('addText').addEventListener('click', () => {
                    this.addElement('text', 'متن جدید');
                });

                document.getElementById('addImage').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                this.addElement('image', event.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                });

                document.getElementById('addShape').addEventListener('click', () => {
                    const shapes = ['rectangle', 'circle', 'triangle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    this.addElement('shape', shape);
                });

                document.getElementById('savePresentation').addEventListener('click', () => {
                    this.saveToCookie();
                    alert('پرزنتیشن با موفقیت ذخیره شد');
                });

                document.getElementById('downloadPPT').addEventListener('click', () => {
                    this.exportToPPTX();
                });

                // تنظیمات قالب‌بندی متن
                const textFormatting = document.getElementById('textFormatting');
                
                document.getElementById('fontFamily').addEventListener('change', (e) => {
                    if (this.selectedElement) {
                        this.selectedElement.style.fontFamily = e.target.value;
                        this.updateElement();
                    }
                });

                document.getElementById('fontSize').addEventListener('change', (e) => {
                    if (this.selectedElement) {
                        this.selectedElement.style.fontSize = e.target.value + 'px';
                        this.updateElement();
                    }
                });

                document.getElementById('bold').addEventListener('click', () => {
                    if (this.selectedElement) {
                        this.selectedElement.style.fontWeight = 
                            this.selectedElement.style.fontWeight === 'bold' ? 'normal' : 'bold';
                        this.updateElement();
                    }
                });

                document.getElementById('italic').addEventListener('click', () => {
                    if (this.selectedElement) {
                        this.selectedElement.style.fontStyle = 
                            this.selectedElement.style.fontStyle === 'italic' ? 'normal' : 'italic';
                        this.updateElement();
                    }
                });

                document.getElementById('textColor').addEventListener('change', (e) => {
                    if (this.selectedElement) {
                        this.selectedElement.style.color = e.target.value;
                        this.updateElement();
                    }
                });

                // اضافه کردن منوی راست کلیک
                document.addEventListener('contextmenu', (e) => {
                    if (e.target.closest('.slide-element')) {
                        e.preventDefault();
                        this.showContextMenu(e);
                    }
                });
            }

            addElement(type, content = '') {
                const slide = this.slides[this.currentSlideIndex];
                const element = {
                    id: Date.now(),
                    type,
                    content,
                    position: { x: 50, y: 50 },
                    style: {},
                    zIndex: this.nextZIndex++
                };

                if (type === 'text') {
                    element.style = {
                        fontSize: '16px',
                        color: '#000000',
                        fontFamily: 'IRANSans'
                    };
                }

                slide.elements.push(element);
                this.render();
                this.saveToCookie();
            }

            deleteElement(elementId) {
                const slide = this.slides[this.currentSlideIndex];
                slide.elements = slide.elements.filter(el => el.id !== elementId);
                this.render();
                this.saveToCookie();
            }

            showContextMenu(e) {
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }

                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.left = `${e.pageX}px`;
                menu.style.top = `${e.pageY}px`;

                const elementId = e.target.closest('.slide-element').dataset.id;

                menu.innerHTML = `
                    <div class="context-menu-item" onclick="presentation.deleteElement(${elementId})">
                        <i class="fas fa-trash"></i>
                        حذف
                    </div>
                    <div class="context-menu-item" onclick="presentation.bringToFront(${elementId})">
                        <i class="fas fa-level-up-alt"></i>
                        انتقال به جلو
                    </div>
                    <div class="context-menu-item" onclick="presentation.sendToBack(${elementId})">
                        <i class="fas fa-level-down-alt"></i>
                        انتقال به عقب
                    </div>
                `;

                document.body.appendChild(menu);

                document.addEventListener('click', () => {
                    menu.remove();
                }, { once: true });
            }

            bringToFront(elementId) {
                const slide = this.slides[this.currentSlideIndex];
                const element = slide.elements.find(el => el.id === elementId);
                if (element) {
                    element.zIndex = this.nextZIndex++;
                    this.render();
                    this.saveToCookie();
                }
            }

            sendToBack(elementId) {
                const slide = this.slides[this.currentSlideIndex];
                const element = slide.elements.find(el => el.id === elementId);
                if (element) {
                    slide.elements.forEach(el => {
                        if (el.zIndex < element.zIndex) {
                            el.zIndex++;
                        }
                    });
                    element.zIndex = 1;
                    this.render();
                    this.saveToCookie();
                }
            }

            makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                let isDragging = false;
                
                const dragMouseDown = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    this.selectedElement = element;
                    document.getElementById('textFormatting').style.display = 
                        element.getAttribute('contenteditable') ? 'flex' : 'none';
                    
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                    isDragging = true;
                };

                const elementDrag = (e) => {
                    e.preventDefault();
                    if (!isDragging) return;

                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;

                    const newTop = element.offsetTop - pos2;
                    const newLeft = element.offsetLeft - pos1;
                    
                    // محدود کردن حرکت به داخل اسلاید
                    const slide = document.getElementById('currentSlide');
                    const maxTop = slide.offsetHeight - element.offsetHeight;
                    const maxLeft = slide.offsetWidth - element.offsetWidth;
                    
                    element.style.top = `${Math.max(0, Math.min(maxTop, newTop))}px`;
                    element.style.left = `${Math.max(0, Math.min(maxLeft, newLeft))}px`;
                };

                const closeDragElement = () => {
                    document.onmouseup = null;
                    document.onmousemove = null;
                    isDragging = false;
                    
                    // ذخیره موقعیت جدید
                    const slide = this.slides[this.currentSlideIndex];
                    const elementId = parseInt(element.dataset.id);
                    const elementData = slide.elements.find(el => el.id === elementId);
                    if (elementData) {
                        elementData.position = {
                            x: parseInt(element.style.left),
                            y: parseInt(element.style.top)
                        };
                        this.saveToCookie();
                    }
                };

                element.onmousedown = dragMouseDown;
            }

            render() {
                const slidesPanel = document.getElementById('slidesPanel');
                slidesPanel.innerHTML = this.slides.map((slide, index) => `
                    <div class="slide-thumbnail ${index === this.currentSlideIndex ? 'active' : ''}"
                         onclick="presentation.setCurrentSlide(${index})">
                        اسلاید ${index + 1}
                    </div>
                `).join('');

                const currentSlide = document.getElementById('currentSlide');
                const slide = this.slides[this.currentSlideIndex];
                
                if (slide) {
                    currentSlide.innerHTML = slide.elements.map(element => {
                        let elementHtml = '';
                        const controls = `
                            <div class="element-controls">
                                <button class="element-control-btn" onclick="presentation.deleteElement(${element.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="element-control-btn" onclick="presentation.bringToFront(${element.id})">
                                    <i class="fas fa-level-up-alt"></i>
                                </button>
                                <button class="element-control-btn" onclick="presentation.sendToBack(${element.id})">
                                    <i class="fas fa-level-down-alt"></i>
                                </button>
                            </div>
                        `;

                        if (element.type === 'text') {
                            elementHtml = `
                                <div class="slide-element" 
                                     data-id="${element.id}"
                                     style="left: ${element.position.x}px; 
                                            top: ${element.position.y}px;
                                            z-index: ${element.zIndex};
                                            ${Object.entries(element.style).map(([key, value]) => `${key}: ${value}`).join(';')}"
                                     contenteditable="true">
                                    ${controls}
                                    ${element.content}
                                </div>
                            `;
                        } else if (element.type === 'image') {
                            elementHtml = `
                                <div class="slide-element" 
                                     data-id="${element.id}"
                                     style="left: ${element.position.x}px; 
                                            top: ${element.position.y}px;
                                            z-index: ${element.zIndex};">
                                    ${controls}
                                    <img src="${element.content}" style="max-width: 300px;">
                                </div>
                            `;
                        } else if (element.type === 'shape') {
                            let shapeHtml = '';
                            if (element.content === 'rectangle') {
                                shapeHtml = `<div style="width: 100px; height: 60px; background: #2b579a;"></div>`;
                            } else if (element.content === 'circle') {
                                shapeHtml = `<div style="width: 80px; height: 80px; background: #2b579a; border-radius: 50%;"></div>`;
                            } else if (element.content === 'triangle') {
                                shapeHtml = `<div style="width: 0; height: 0; border-left: 40px solid transparent; border-right: 40px solid transparent; border-bottom: 80px solid #2b579a;"></div>`;
                            }

                            elementHtml = `
                                <div class="slide-element" 
                                     data-id="${element.id}"
                                     style="left: ${element.position.x}px; 
                                            top: ${element.position.y}px;
                                            z-index: ${element.zIndex};">
                                    ${controls}
                                    ${shapeHtml}
                                </div>
                            `;
                        }

                        return elementHtml;
                    }).join('');

                    const elements = currentSlide.getElementsByClassName('slide-element');
                    Array.from(elements).forEach(element => {
                        this.makeDraggable(element);
                    });
                }
            }

            setCurrentSlide(index) {
                this.currentSlideIndex = index;
                this.render();
            }

            updateElement() {
                if (this.selectedElement) {
                    const slide = this.slides[this.currentSlideIndex];
                    const elementId = parseInt(this.selectedElement.dataset.id);
                    const elementData = slide.elements.find(el => el.id === elementId);
                    if (elementData) {
                        elementData.style = {
                            ...elementData.style,
                            fontFamily: this.selectedElement.style.fontFamily,
                            fontSize: this.selectedElement.style.fontSize,
                            fontWeight: this.selectedElement.style.fontWeight,
                            fontStyle: this.selectedElement.style.fontStyle,
                            color: this.selectedElement.style.color
                        };
                        this.saveToCookie();
                    }
                }
            }

            async exportToPPTX() {
                const zip = new JSZip();
                
                // ایجاد تصویر از هر اسلاید
                const slidePromises = this.slides.map(async (slide, index) => {
                    const slideElement = document.getElementById('currentSlide').cloneNode(true);
                    slideElement.style.position = 'fixed';
                    slideElement.style.left = '-9999px';
                    document.body.appendChild(slideElement);
                    
                    const canvas = await html2canvas(slideElement);
                    document.body.removeChild(slideElement);
                    
                    return canvas.toDataURL('image/png');
                });

                const slideImages = await Promise.all(slidePromises);
                
                const pptx = {
                    presentation: {
                        slides: slideImages.map((image, index) => ({
                            id: index + 1,
                            image: image
                        }))
                    }
                };

                zip.file("presentation.json", JSON.stringify(pptx));
                
                const content = await zip.generateAsync({type: "blob"});
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'presentation.pptx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        const presentation = new Presentation();
    </script>
</body>
</html>
